version: '3.8'


services:

  # =======================
  # MYSQL
  # =======================
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: user123
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db_init:/docker-entrypoint-initdb.d
    networks:
      - spa_network

  # =======================
  # MONGODB
  # =======================
  mongo:
    image: mongo:6.0
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
      - ./mongo_backups:/docker-entrypoint-initdb.d
    networks:
      - spa_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
  # =======================
  # GATEWAY LARAVEL
  # =======================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile-laravel
    container_name: gateway
    ports:
      - "8000:8000"
    env_file:
      - ./gateway/.env
    volumes:
      - ./gateway:/var/www/html
    depends_on:
      auth:
        condition: service_started
      servicios:
        condition: service_started
      reservas:
        condition: service_started
      auditoria:
        condition: service_started
      reportes:
        condition: service_started
      notificaciones:
        condition: service_started
    networks:
      - spa_network

  # =======================
  # AUTH (LARAVEL)
  # =======================
  auth:
    build:
      context: ./auth-service
      dockerfile: Dockerfile-laravel
    container_name: auth
    ports:
      - "8001:8001"   
    env_file:
      - ./auth-service/.env
    depends_on:
      - mysql
    networks:
      - spa_network

  # =======================
  # SERVICIOS (DJANGO)
  # =======================
  servicios:
    build:
      context: ./servicios_ms
      dockerfile: Dockerfile-django
    container_name: servicios
    ports:
      - "8002:8002"
    env_file:
      - ./servicios_ms/.env
    depends_on:
      - mysql
    networks:
      - spa_network

  # =======================
  # RESERVAS (FLASK)
  # =======================
  reservas:
    build:
      context: ./reservas_ms
      dockerfile: Dockerfile-flask
    container_name: reservas
    ports:
      - "5001:5001"
    env_file:
      - ./reservas_ms/.env
    command: ["python", "app.py"]
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - spa_network

  # =======================
  # AUDITOR√çA (FLASK)
  # =======================
  auditoria:
    build:
      context: ./auditoria_ms
      dockerfile: Dockerfile-flask
    container_name: auditoria
    ports:
      - "5003:5003"
    env_file:
      - ./auditoria_ms/.env
    command: ["python", "app.py"]
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - spa_network

  # =======================
  # REPORTES (FLASK)
  # =======================
  reportes:
    build:
      context: ./reportes_ms
      dockerfile: Dockerfile-flask
    container_name: reportes
    ports:
      - "5005:5005"
    env_file:
      - ./reportes_ms/.env
    command: ["python", "app.py"]
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - spa_network

  # =======================
  # NOTIFICACIONES (FLASK)
  # =======================
  notificaciones:
    build:
      context: ./ms_notificaciones
      dockerfile: Dockerfile-flask
    container_name: notificaciones
    ports:
      - "5004:5004"
    env_file:
      - ./ms_notificaciones/.env
    command: ["python", "app.py"]
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - spa_network

# =======================
# VOLUMES
# =======================
volumes:
  mysql_data:
  mongo_data:

# =======================
# NETWORK
# =======================
networks:
  spa_network:
    driver: bridge
