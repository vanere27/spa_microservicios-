version: '3.9'


services:
  # =======================
  # Contenedor MySQL
  # =======================
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: user123
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db_init:/docker-entrypoint-initdb.d
    networks:
      - spa_network

  # =======================
  # Contenedor MongoDB
  # =======================
  mongo:
    image: mongo:6.0
    container_name: mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
      - ./mongo_backups:/docker-entrypoint-initdb.d
    networks:
      - spa_network
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =======================
  # Gateway Laravel
  # =======================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile-laravel
    container_name: gateway
    ports:
      - "8000:8000"
    env_file:
      - ./gateway/.env
    volumes:
      - ./gateway:/var/www/html
    depends_on:
      - auth
      - servicios
      - reservas
      - auditoria
      - reportes
      - notificaciones
    networks:
      - spa_network


  # =======================
  # Microservicio Auth
  # =======================
  auth:
    build:
      context: ./auth-service
      dockerfile: Dockerfile-laravel
    container_name: auth
    ports:
      - "8001:8001"
    env_file:
      - ./auth-service/.env
    depends_on:
      - mysql
    command: >
      sh -c "dockerize -wait tcp://mysql:3306 -timeout 60s php artisan serve --host=0.0.0.0 --port=8001"
    networks:
      - spa_network


  # =======================
  # Microservicio Servicios (Django)
  # =======================
  servicios:
    build:
      context: ./servicios_ms
      dockerfile: Dockerfile-django
    container_name: servicios
    ports:
      - "8002:8002"
    env_file:
      - ./servicios_ms/.env
    depends_on:
      - mysql
    networks:
      - spa_network

  # =======================
  # Microservicio Reservas (Flask)
  # =======================
  reservas:
    build:
      context: ./reservas_ms
      dockerfile: Dockerfile-flask
    container_name: reservas
    ports:
      - "5001:5001"
    env_file:
      - ./reservas_ms/.env
    command: ["python", "app.py"]
    depends_on:
      - mongo
    networks:
      - spa_network


  # =======================
  # Microservicio Auditoría (Flask)
  # =======================
  auditoria:
    build:
      context: ./auditoria_ms
      dockerfile: Dockerfile-flask
    container_name: auditoria
    ports:
      - "5003:5003"
    env_file:
      - ./auditoria_ms/.env
    command: ["python", "app.py"]
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - spa_network


  # =======================
  # Microservicio Reportes (Flask)
  # =======================
  reportes:
    build:
      context: ./reportes_ms
      dockerfile: Dockerfile-flask
    container_name: reportes
    ports:
      - "5005:5005"
    env_file:
      - ./reportes_ms/.env
    command: ["python", "app.py"]
    depends_on:
      - mongo
    networks:
      - spa_network

  # =======================
  # Microservicio Notificaciones (Flask)
  # =======================
  notificaciones:
    build:
      context: ./ms_notificaciones
      dockerfile: Dockerfile-flask
    container_name: notificaciones
    ports:
      - "5004:5004"
    env_file:
      - ./ms_notificaciones/.env
    command: ["python", "app.py"]
    depends_on:
      - mongo
    networks:
      - spa_network

# =======================
# Volúmenes persistentes
# =======================
volumes:
  mysql_data:
  mongo_data:
networks:
  spa_network:
    driver: bridge